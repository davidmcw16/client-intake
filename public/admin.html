<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Project Intakes</title>
  <style>
    :root {
      --bg: #0a0a0f;
      --card: #14141f;
      --text: #e8e8f0;
      --accent: #6366f1;
      --accent-hover: #818cf8;
      --border: #1e1e2e;
      --muted: #888899;
      --green: #22c55e;
      --yellow: #eab308;
      --red: #ef4444;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.6;
      min-height: 100vh;
    }

    /* ---- Auth Overlay ---- */
    #auth-overlay {
      position: fixed;
      inset: 0;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .auth-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 40px;
      width: 100%;
      max-width: 400px;
      text-align: center;
    }

    .auth-card h1 {
      font-size: 1.5rem;
      margin-bottom: 8px;
    }

    .auth-card p {
      color: var(--muted);
      font-size: 0.9rem;
      margin-bottom: 24px;
    }

    #password-input {
      width: 100%;
      padding: 12px 16px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 1rem;
      outline: none;
      transition: border-color 0.2s;
    }

    #password-input:focus {
      border-color: var(--accent);
    }

    .auth-error {
      color: var(--red);
      font-size: 0.85rem;
      margin-top: 8px;
      min-height: 1.2em;
    }

    .btn-login {
      width: 100%;
      margin-top: 16px;
      padding: 12px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn-login:hover {
      background: var(--accent-hover);
    }

    .btn-login:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ---- Dashboard ---- */
    #dashboard {
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px;
    }

    .dashboard-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 32px;
    }

    .dashboard-header h1 {
      font-size: 1.75rem;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .count-badge {
      background: var(--accent);
      color: #fff;
      font-size: 0.8rem;
      font-weight: 700;
      padding: 2px 10px;
      border-radius: 12px;
    }

    .btn-logout {
      background: none;
      border: 1px solid var(--border);
      color: var(--muted);
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: color 0.2s, border-color 0.2s;
    }

    .btn-logout:hover {
      color: var(--text);
      border-color: var(--muted);
    }

    /* ---- Empty State ---- */
    #empty-state {
      display: none;
      text-align: center;
      padding: 80px 20px;
      color: var(--muted);
    }

    #empty-state .empty-icon {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.4;
    }

    #empty-state p {
      font-size: 1rem;
      max-width: 400px;
      margin: 0 auto;
    }

    /* ---- Intake List ---- */
    #intake-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .intake-row {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    .intake-row:hover {
      border-color: var(--accent);
    }

    .intake-row-header {
      display: grid;
      grid-template-columns: 1fr auto auto auto auto auto auto;
      align-items: center;
      gap: 16px;
      padding: 16px 20px;
    }

    .intake-name {
      font-weight: 600;
      font-size: 1rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .intake-date {
      color: var(--muted);
      font-size: 0.85rem;
      white-space: nowrap;
    }

    .intake-duration {
      color: var(--muted);
      font-size: 0.85rem;
      white-space: nowrap;
    }

    .intake-turns {
      color: var(--muted);
      font-size: 0.85rem;
      white-space: nowrap;
    }

    .confidence-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
    }

    .confidence-dot.green { background: var(--green); }
    .confidence-dot.yellow { background: var(--yellow); }
    .confidence-dot.red { background: var(--red); }

    .intake-vision {
      color: var(--muted);
      font-size: 0.85rem;
      max-width: 200px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .intake-actions {
      display: flex;
      gap: 8px;
    }

    .btn-icon {
      background: none;
      border: 1px solid var(--border);
      color: var(--muted);
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: color 0.2s, border-color 0.2s, background 0.2s;
      white-space: nowrap;
    }

    .btn-icon:hover {
      color: var(--text);
      border-color: var(--muted);
    }

    .btn-icon.delete:hover {
      color: var(--red);
      border-color: var(--red);
      background: rgba(239, 68, 68, 0.08);
    }

    /* ---- Expanded Detail ---- */
    .intake-detail {
      display: none;
      padding: 0 20px 20px 20px;
      border-top: 1px solid var(--border);
    }

    .intake-row.expanded .intake-detail {
      display: block;
    }

    .detail-section {
      margin-top: 20px;
    }

    .detail-section h3 {
      font-size: 0.9rem;
      color: var(--accent);
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Conversation bubbles */
    .conversation-log {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 400px;
      overflow-y: auto;
      padding-right: 8px;
    }

    .conversation-log::-webkit-scrollbar {
      width: 6px;
    }

    .conversation-log::-webkit-scrollbar-track {
      background: var(--bg);
    }

    .conversation-log::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }

    .bubble {
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 0.9rem;
      line-height: 1.5;
      max-width: 80%;
    }

    .bubble.ai {
      align-self: flex-start;
      background: var(--bg);
      border-left: 3px solid var(--accent);
    }

    .bubble.client {
      align-self: flex-end;
      background: var(--card);
      border: 1px solid var(--border);
    }

    .bubble-role {
      font-size: 0.75rem;
      color: var(--muted);
      margin-bottom: 4px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    /* Confidence breakdown */
    .confidence-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 10px;
    }

    .confidence-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      background: var(--bg);
      border-radius: 8px;
      font-size: 0.85rem;
    }

    .confidence-item .label {
      color: var(--muted);
    }

    .confidence-item .score {
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
    }

    .confidence-item .score.high {
      color: var(--green);
      background: rgba(34, 197, 94, 0.1);
    }

    .confidence-item .score.medium {
      color: var(--yellow);
      background: rgba(234, 179, 8, 0.1);
    }

    .confidence-item .score.low {
      color: var(--red);
      background: rgba(239, 68, 68, 0.1);
    }

    /* Markdown preview */
    .markdown-preview {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      overflow-x: auto;
      font-size: 0.85rem;
      line-height: 1.6;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
      color: var(--muted);
      max-height: 500px;
      overflow-y: auto;
    }

    /* Loading spinner */
    .spinner {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 900px) {
      #dashboard {
        padding: 16px;
      }

      .intake-row-header {
        grid-template-columns: 1fr auto auto;
        gap: 8px;
      }

      .intake-date,
      .intake-duration,
      .intake-turns,
      .intake-vision {
        display: none;
      }

      .confidence-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

  <!-- Auth Overlay -->
  <div id="auth-overlay">
    <div class="auth-card">
      <h1>Admin Login</h1>
      <p>Enter the admin password to view project intakes.</p>
      <input type="password" id="password-input" placeholder="Password" autocomplete="current-password">
      <div class="auth-error" id="auth-error"></div>
      <button class="btn-login" id="btn-login">Log In</button>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" style="display:none;">
    <div class="dashboard-header">
      <h1>Project Intakes <span class="count-badge" id="count-badge">0</span></h1>
      <button class="btn-logout" id="btn-logout">Log Out</button>
    </div>

    <div id="empty-state">
      <div class="empty-icon">&#128203;</div>
      <p>No intakes yet. Share your intake link with a client to get started.</p>
    </div>

    <div id="intake-list"></div>
  </div>

  <script>
    let password = '';

    // ---- Auth ----
    const authOverlay = document.getElementById('auth-overlay');
    const dashboard = document.getElementById('dashboard');
    const passwordInput = document.getElementById('password-input');
    const btnLogin = document.getElementById('btn-login');
    const authError = document.getElementById('auth-error');
    const btnLogout = document.getElementById('btn-logout');

    // Check for existing session
    (function checkSession() {
      const saved = sessionStorage.getItem('admin_password');
      if (saved) {
        password = saved;
        tryLogin(true);
      }
    })();

    passwordInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') btnLogin.click();
    });

    btnLogin.addEventListener('click', () => {
      password = passwordInput.value.trim();
      if (!password) {
        authError.textContent = 'Please enter a password.';
        return;
      }
      tryLogin(false);
    });

    btnLogout.addEventListener('click', () => {
      sessionStorage.removeItem('admin_password');
      password = '';
      passwordInput.value = '';
      authError.textContent = '';
      dashboard.style.display = 'none';
      authOverlay.style.display = 'flex';
    });

    async function tryLogin(fromSession) {
      btnLogin.disabled = true;
      authError.textContent = '';

      try {
        const res = await fetch('/api/admin/intakes', {
          headers: { 'Authorization': `Bearer ${password}` }
        });

        if (res.status === 401) {
          if (fromSession) {
            sessionStorage.removeItem('admin_password');
            password = '';
          } else {
            authError.textContent = 'Incorrect password';
          }
          btnLogin.disabled = false;
          return;
        }

        if (!res.ok) {
          authError.textContent = `Server error (${res.status})`;
          btnLogin.disabled = false;
          return;
        }

        // Success
        sessionStorage.setItem('admin_password', password);
        authOverlay.style.display = 'none';
        dashboard.style.display = 'block';

        const data = await res.json();
        renderIntakes(data.intakes || data);
      } catch (err) {
        authError.textContent = 'Connection failed. Is the server running?';
      } finally {
        btnLogin.disabled = false;
      }
    }

    // ---- Render Intakes ----
    const intakeList = document.getElementById('intake-list');
    const emptyState = document.getElementById('empty-state');
    const countBadge = document.getElementById('count-badge');

    function renderIntakes(intakes) {
      intakeList.innerHTML = '';

      if (!intakes || intakes.length === 0) {
        emptyState.style.display = 'block';
        countBadge.textContent = '0';
        return;
      }

      emptyState.style.display = 'none';
      countBadge.textContent = intakes.length;

      intakes.forEach((intake) => {
        const row = createIntakeRow(intake);
        intakeList.appendChild(row);
      });
    }

    function createIntakeRow(intake) {
      const row = document.createElement('div');
      row.className = 'intake-row';
      row.dataset.id = intake.id;

      const clientName = intake.client_name || intake.clientName || 'Unknown';
      const date = formatDate(intake.created_at || intake.createdAt);
      const durationMs = intake.duration_ms || intake.durationMs || (intake.duration_seconds || intake.durationSeconds || 0) * 1000;
      const duration = formatDuration(durationMs / 1000);
      const turns = intake.turn_count || intake.turnCount || 0;
      const confidenceObj = intake.confidence || {};
      const scores = Object.values(confidenceObj).filter(v => typeof v === 'number');
      const confidence = scores.length > 0
        ? scores.reduce((a, b) => a + b, 0) / scores.length
        : (intake.overall_confidence || intake.overallConfidence || 0);
      const confClass = confidence >= 0.7 ? 'green' : confidence >= 0.4 ? 'yellow' : 'red';
      let vision = '';
      if (intake.markdown) {
        const visionMatch = intake.markdown.match(/### Vision\n+([^\n#]+)/);
        if (visionMatch) {
          vision = truncate(visionMatch[1].trim(), 100);
        } else {
          vision = truncate(intake.markdown.substring(0, 100), 100);
        }
      }

      row.innerHTML = `
        <div class="intake-row-header">
          <span class="intake-name">${escapeHtml(clientName)}</span>
          <span class="intake-date">${date}</span>
          <span class="intake-duration">${duration}</span>
          <span class="intake-turns">${turns} turns</span>
          <span class="confidence-dot ${confClass}" title="Confidence: ${Math.round(confidence * 100)}%"></span>
          <span class="intake-vision" title="${escapeHtml(vision)}">${escapeHtml(vision)}</span>
          <span class="intake-actions">
            <button class="btn-icon download" onclick="event.stopPropagation(); downloadIntake('${intake.id}', '${escapeAttr(clientName)}')">Download</button>
            <button class="btn-icon delete" onclick="event.stopPropagation(); deleteIntake('${intake.id}', this)">Delete</button>
          </span>
        </div>
        <div class="intake-detail" id="detail-${intake.id}"></div>
      `;

      row.querySelector('.intake-row-header').addEventListener('click', () => {
        toggleDetail(row, intake);
      });

      return row;
    }

    // ---- Expand / Collapse ----
    async function toggleDetail(row, intake) {
      if (row.classList.contains('expanded')) {
        row.classList.remove('expanded');
        return;
      }

      // Collapse others
      document.querySelectorAll('.intake-row.expanded').forEach((r) => {
        r.classList.remove('expanded');
      });

      const detail = row.querySelector('.intake-detail');

      if (!detail.dataset.loaded) {
        // Use the intake data we already have from the list response
        detail.innerHTML = buildDetailHtml(intake);
        detail.dataset.loaded = 'true';
      }

      row.classList.add('expanded');
    }

    function buildDetailHtml(intake) {
      let html = '';

      // Conversation transcript
      const conversation = intake.conversation || intake.messages || [];
      if (conversation.length > 0) {
        html += `
          <div class="detail-section">
            <h3>Conversation Transcript</h3>
            <div class="conversation-log">
              ${conversation.map((msg) => {
                const role = (msg.role || '').toLowerCase();
                const isAi = role === 'assistant' || role === 'ai' || role === 'agent';
                return `
                  <div class="bubble ${isAi ? 'ai' : 'client'}">
                    <div class="bubble-role">${isAi ? 'AI' : 'Client'}</div>
                    ${escapeHtml(msg.content || msg.text || '')}
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      }

      // Confidence breakdown
      const confidenceBreakdown = intake.confidence_breakdown || intake.confidenceBreakdown || intake.confidence || {};
      const categories = Object.entries(confidenceBreakdown);
      if (categories.length > 0) {
        html += `
          <div class="detail-section">
            <h3>Confidence Breakdown</h3>
            <div class="confidence-grid">
              ${categories.map(([key, value]) => {
                const score = typeof value === 'number' ? value : (value.score || 0);
                const pct = Math.round(score * 100);
                const cls = score >= 0.7 ? 'high' : score >= 0.4 ? 'medium' : 'low';
                const label = formatCategoryLabel(key);
                return `
                  <div class="confidence-item">
                    <span class="label">${escapeHtml(label)}</span>
                    <span class="score ${cls}">${pct}%</span>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      }

      // Generated markdown
      const markdown = intake.markdown || intake.generated_markdown || intake.generatedMarkdown || '';
      if (markdown) {
        html += `
          <div class="detail-section">
            <h3>Generated Markdown</h3>
            <pre class="markdown-preview">${escapeHtml(markdown)}</pre>
          </div>
        `;
      }

      if (!html) {
        html = '<div style="padding:20px;color:var(--muted);">No additional details available.</div>';
      }

      return html;
    }

    // ---- Download ----
    async function downloadIntake(id, clientName) {
      const res = await fetch(`/api/admin/intakes/${id}/markdown`, {
        headers: { 'Authorization': `Bearer ${password}` }
      });
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `intake-${clientName}.md`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // ---- Delete ----
    async function deleteIntake(id, btn) {
      if (!confirm('Are you sure you want to delete this intake? This cannot be undone.')) return;

      btn.disabled = true;
      btn.textContent = '...';

      try {
        const res = await fetch(`/api/admin/intakes/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${password}` }
        });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const row = btn.closest('.intake-row');
        row.style.transition = 'opacity 0.3s, transform 0.3s';
        row.style.opacity = '0';
        row.style.transform = 'translateX(20px)';
        setTimeout(() => {
          row.remove();
          updateCount();
        }, 300);
      } catch (err) {
        alert('Failed to delete intake: ' + err.message);
        btn.disabled = false;
        btn.textContent = 'Delete';
      }
    }

    function updateCount() {
      const rows = intakeList.querySelectorAll('.intake-row');
      countBadge.textContent = rows.length;
      if (rows.length === 0) {
        emptyState.style.display = 'block';
      }
    }

    // ---- Utilities ----
    function formatDate(isoString) {
      if (!isoString) return '';
      const d = new Date(isoString);
      return d.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
      });
    }

    function formatDuration(seconds) {
      if (!seconds) return '';
      const mins = Math.round(seconds / 60);
      return `${mins} min`;
    }

    function truncate(str, max) {
      if (!str) return '';
      return str.length > max ? str.slice(0, max) + '...' : str;
    }

    function formatCategoryLabel(key) {
      return key
        .replace(/_/g, ' ')
        .replace(/([A-Z])/g, ' $1')
        .replace(/^\w/, (c) => c.toUpperCase())
        .trim();
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function escapeAttr(str) {
      return str.replace(/'/g, "\\'").replace(/"/g, '&quot;');
    }
  </script>
</body>
</html>
